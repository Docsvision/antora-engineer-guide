= Определение связей между разделами

В отличие от рядового пользователя, администратор {dv} может расширить список доступных для вывода в представлении полей, указывая при его создании связи между разделами карточек.

На рисунке ниже представлено диалоговое окно _Настройка элементов представления_, открытое администратором {dv}. Кроме поля _Колонки представления_, имеющегося в окне, открытом рядовым пользователем, здесь расположено поле _Присоединенные разделы_, в котором можно присоединить к ведущему разделу карточки некоторый другой раздел этой же или другой карточки.

.Окно "Настройка элементов представления", открытое администратором {dv}
image::view-settings-append.png[Окно "Настройка элементов представления", открытое администратором {dv}]

Элементы, источник данных которых хранится в ведущем разделе и не является ссылочным полем (на рисунке это элементы колонок _Название_, _Дата регистрации_ и _Содержание_), определяются так же, как это описано в пункте xref:view-data-settings.adoc[].

Ниже приведено подробное описание настройки элемента представления, источник данных которого расположен не в ведущем разделе и, следовательно, нуждается в присоединении.

По кнопке *Добавить*, расположенной справа от поля _Присоединенные разделы_, открывается диалог настройки дополнительных разделов, необходимых для отображения данных в представлении.

.Окно "Присоединенный раздел"
image::append-section.png[Окно "Присоединенный раздел"]

В полях окна _Присоединенный раздел_ прежде всего указывается _Оригинальный раздел_ -- тот раздел, поле которого будет использоваться в качестве ключа для связи с другим разделом. Оригинальный раздел выбирается в окне _Выбор раздела_, открывающемся по кнопке image:buttons/three-dots.png[Три точки] справа от поля. По умолчанию в качестве оригинального всегда доступен ведущий раздел. Кроме того, доступны и все разделы, присоединенные к ведущему (ранее, при создании этого же представления).

.Окно "Выбор раздела"
image::select-section-lead.png[Окно "Выбор раздела"]

После указания оригинального раздела указывается _Оригинальное поле_, данные из которого являются ссылкой к присоединяемому разделу. После этого поля _Присоединяемый раздел_ и _Присоединяемое поле_ заполняются автоматически теми значениями, которые соответствуют настраиваемой связи. Поле _Псевдоним_ заполняется предлагаемым названием присоединяемого раздела, но при необходимости значения этих полей пользователь может изменить.

Среди полей, доступных в списках _Оригинальное поле_ и _Присоединяемое поле_, всегда есть системные поля:

* `InstanceID` -- идентификатор карточки.
* `ParentRowID` -- идентификатор родительской строки.
* `ParentTreeRowID` -- идентификатор родительской строки в дереве.
* `RowID` -- идентификатор строки карточки.
* `SysRowTimestamp` -- служебное поле.

[NOTE]
====
При присоединении к оригинальному разделу другого раздела этой же карточки в полях _Оригинальное поле_ и _Присоединяемое поле_ должен быть выбран пункт `InstanceID`.
====

Поля _Присоединяемый раздел_ и _Присоединяемое поле_ имеет смысл заполнять вручную в том случае, когда к ведущему разделу нужно присоединить не секцию какой-либо карточки, а таблицу базы данных {dv} и её поле (например, таким способом можно вывести в представлении все ссылки из входящих документов).

WARNING: Если таблица и столбец соединения указаны вручную, обеспечьте сопоставление строк таким образом, чтобы на одну строку ведущего раздела приходилось не более одной строки присоединяемого раздела.
При необходимости присоединения таблицы по полю `InstanceID` необходимо учесть, что для корректной работы представления данное поле должно быть уникальным.

При таком присоединении необходимо обратить внимание на следующую особенность: если тип поля, по которому происходит соединение, не `uniqueidentifier`, после создания представления нужно:

. xref:view-xml-export.adoc[Выгрузить представление] в файл XML.
. Изменить выгруженный файл, указав в секции `JoinDef` у параметра `DestFieldType` (тип поля), его фактическое значение.
+
.Например:
[source]
----
<JoinDef Alias="UserJoin_1" SourceAlias="Main" SourceField="AccountName" DestField="AccountName" TableName="dvsys_users" DestFieldType="unistring"/> <.>
----
<.> Возможные типы полей: `Int`, `Bool`, `DateTime`, `UniqueId`, `String`, `Unistring`, `Float`, `Decimal`, `Binary`.
+
. xref:view-xml-import.adoc[Импортировать представление] из изменённого файла.
+
--
.После создания присоединенного раздела данные из него могут быть указаны в качестве элемента представления:
.. Вернитесь к полю _Колонки представления_.
.. Выделите нужную строчку.
.. Двойным щелчком мыши откройте окно _Настройка данных колонки_.
.. В этом окне в качестве _Типа данных_ укажите _Поле раздела_.
.. По кнопке поля _Элемент_, откройте окно _Выбор раздела_.
.. Теперь в этом окне выберите поле, из которого будет считываться информация. Для выбора доступны поля оригинального и всех присоединенных разделов.
--

На рисунке представлен пример выбора поля для настройки элемента представления, отображающегося в колонке _Вид_. В качестве раздела укажите присоединенный раздел _DocumentTypes_1_ (название псевдонима по умолчанию; псевдоним виден в списке доступных разделов). Далее в этом разделе выбирается нужное поле (в данном случае -- _Название_ вида документа).

.Окно "Выбор раздела"
image::select-section-name.png[Окно "Выбор раздела"]

.Флаги окна "Присоединенный раздел" позволяют выводить в представлении данные иерархии:
* `*Раскрывать иерархию присоединяемого раздела*` -- основной флаг, при установке которого становятся доступными остальные флаги секции.
* При установленном флаге `*Присоединять родительские элементы иерархии*` иерархия будет раскрыта в сторону родительских элементов, при снятом -- в сторону дочерних.
* Флаг `*Выводить только корневой родительский элемент*` позволяет вывести в представлении только корневой элемент иерархии, минуя все промежуточные. Например, для элемента _Сотрудник_ в представлении будет выведен элемент _Организация_ без элемента _Подразделение_.
* Счетчик, активизирующийся при установленном флаге `*Ограничивать вывод иерархии уровнем*`, позволяет указать уровень выводимых в представление узлов иерархии относительно текущего элемента.

В поле _Условие на основной раздел представления_ окна _Настройка элементов представления_ определяются условия вывода данных ведущего (основного) раздела карточки в представлении.
Задаются эти условия так же, как и xref:view-append-section.adoc[условия присоединения раздела].
